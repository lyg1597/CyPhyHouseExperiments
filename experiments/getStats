#!/bin/bash

TIMEOUT="120s"

appName=$1
appName_stats="stats/${appName}.stats"

if [ -f $appName ]; then
    echo "User specified \"$appName\""
else
    echo "\"$appName\" is not found"
    exit 1
fi

if [ -d $appName_stats ]; then
    echo "\"$appName_stats\" already exists. Overwriting logs..."
fi

mkdir -p $appName_stats

gz stats --plot > $appName_stats/RTStats.csv &
GZ_PID=$!
python3 node_stats.py $appName_stats/UsageStats.csv &
nodeStat_PID=$!
tshark -o ip.defragment:FALSE -f "udp portrange 2000-2016" -Y udp \
    -Tfields -E header=y -E separator=, \
    -e frame.number -e frame.time_relative -e udp.dstport -e udp.length \
    > $appName_stats/PacketStats.csv &
tshark_PID=$!
sleep 8s
echo "Start Collecting Data!"

function finish
{
  kill -INT $GZ_PID
  kill -TERM $nodeStat_PID
  kill -INT $tshark_PID
}
trap finish EXIT

echo "Press Ctrl-C to end user application and data collection"
timeout --foreground -s INT $TIMEOUT python3 $appName

